---
variables:
  CLOUD_IMAGE_VERSION: dev
  CLOUD_IMAGE_NAME: debian-${CLOUD_IMAGE_RELEASE}-${CLOUD_IMAGE_VERSION}-${CLOUD_VENDOR}-${CLOUD_ARCH}

.build: &build
  stage: build
  image: debian:stretch-backports
  script:
    - apt-get update
    - >
      apt-get install --no-install-recommends -y -t stretch-backports
      ca-certificates debsums fai-server fai-setup-storage make python3 sudo qemu-utils udev
    - bin/build ${CLOUD_RELEASE} ${CLOUD_VENDOR} ${CLOUD_ARCH} ${CLOUD_IMAGE_NAME} ${CLOUD_OPTIONS}
    - 'xz -vk5T0 *.tar'
  artifacts:
    name: ${CLOUD_IMAGE_NAME}
    expire_in: 2 days
    paths:
      - '*.info'
      - '*.manifest.yml'
      - '*.tar.xz'

.only-pushes: &only-pushes
  only:
    - pushes

.only-triggers-official: &only-triggers-official
  only:
    - triggers@cloud-team/debian-cloud-images

.only-web: &only-web
  only:
    - web

azure stretch build: &build-azure-stretch
  <<: *build
  <<: *only-web
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: stretch
    CLOUD_IMAGE_RELEASE: 9
    CLOUD_VENDOR: azure

azure stretch-backports build: &build-azure-stretch-backports
  <<: *build
  <<: *only-web
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: stretch-backports
    CLOUD_IMAGE_RELEASE: 9-backports
    CLOUD_VENDOR: azure

azure buster build: &build-azure-buster
  <<: *build
  <<: *only-web
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: buster
    CLOUD_IMAGE_RELEASE: 10
    CLOUD_VENDOR: azure
  # no waagent in buster
  allow_failure: true

azure sid build: &build-azure-sid
  <<: *build
  <<: *only-pushes
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: sid
    CLOUD_IMAGE_RELEASE: sid
    CLOUD_VENDOR: azure

ec2 stretch build: &build-ec2-stretch
  <<: *build
  <<: *only-web
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: stretch
    CLOUD_IMAGE_RELEASE: 9
    CLOUD_VENDOR: ec2

ec2 buster build: &build-ec2-buster
  <<: *build
  <<: *only-web
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: buster
    CLOUD_IMAGE_RELEASE: 10
    CLOUD_VENDOR: ec2

ec2 sid build: &build-ec2-sid
  <<: *build
  <<: *only-pushes
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: sid
    CLOUD_IMAGE_RELEASE: sid
    CLOUD_VENDOR: ec2

gce stretch build: &build-gce-stretch
  <<: *build
  <<: *only-web
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: stretch
    CLOUD_IMAGE_RELEASE: 9
    CLOUD_VENDOR: gce

gce buster build: &build-gce-buster
  <<: *build
  <<: *only-web
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: buster
    CLOUD_IMAGE_RELEASE: 10
    CLOUD_VENDOR: gce
  # uses external stuff
  allow_failure: true

gce sid build: &build-gce-sid
  <<: *build
  <<: *only-pushes
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: sid
    CLOUD_IMAGE_RELEASE: sid
    CLOUD_VENDOR: gce
  # uses external stuff
  allow_failure: true

nocloud stretch build: &build-nocloud-stretch
  <<: *build
  <<: *only-web
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: stretch
    CLOUD_IMAGE_RELEASE: 9
    CLOUD_VENDOR: nocloud

nocloud buster build: &build-nocloud-buster
  <<: *build
  <<: *only-web
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: buster
    CLOUD_IMAGE_RELEASE: 10
    CLOUD_VENDOR: nocloud

nocloud sid build: &build-nocloud-sid
  <<: *build
  <<: *only-pushes
  tags:
    - x86
  variables:
    CLOUD_ARCH: amd64
    CLOUD_RELEASE: sid
    CLOUD_IMAGE_RELEASE: sid
    CLOUD_VENDOR: nocloud

azure stretch build official:
  <<: *build-azure-stretch
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

azure stretch-backports build official:
  <<: *build-azure-stretch-backports
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

azure buster build official:
  <<: *build-azure-buster
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

azure sid build official:
  <<: *build-azure-sid
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

ec2 stretch build official:
  <<: *build-ec2-stretch
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

ec2 buster build official:
  <<: *build-ec2-buster
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

ec2 sid build official:
  <<: *build-ec2-sid
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

gce stretch build official:
  <<: *build-gce-stretch
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

gce buster build official:
  <<: *build-gce-buster
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

gce sid build official:
  <<: *build-gce-sid
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

nocloud stretch build official:
  <<: *build-nocloud-stretch
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

nocloud buster build official:
  <<: *build-nocloud-buster
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86

nocloud sid build official:
  <<: *build-nocloud-sid
  <<: *only-triggers-official
  tags:
    - debian-cloud-images-build
    - x86
